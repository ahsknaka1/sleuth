<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleuth - Web Recon Interface</title>
    <!-- No DataTables CSS needed anymore -->
    <style>
        :root {
            --dark-bg-primary: #0d1117; --dark-bg-secondary: #161b22; --border-color: #30363d;
            --text-primary: #c9d1d9; --text-secondary: #8b949e; --accent-cyan: #39c5fe;
            --accent-green: #3fb950; --accent-red: #f85149;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--dark-bg-primary); color: var(--text-primary); margin: 0; padding: 2em;
        }
        .container { display: flex; flex-direction: column; gap: 25px; max-width: 1400px; margin: 0 auto; }
        header h1 { color: var(--text-primary); font-size: 2em; margin: 0; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .card { background-color: var(--dark-bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 24px; }
        h3 { color: var(--text-primary); font-size: 1.25em; margin: 0 0 20px 0; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        
        /* --- Scan Controls Tabs & Inputs --- */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-button { background: none; border: none; color: var(--text-secondary); padding: 10px 20px; cursor: pointer; font-size: 16px; border-bottom: 3px solid transparent; }
        .tab-button.active { color: var(--text-primary); border-bottom-color: var(--accent-cyan); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .input-field { background-color: var(--dark-bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 12px; font-size: 16px; }
        .input-field:focus { outline: none; border-color: var(--accent-cyan); box-shadow: 0 0 0 3px rgba(57, 197, 254, 0.2); }
        .scan-button { padding: 10px 18px; font-size: 16px; font-weight: 500; color: white; border: none; cursor: pointer; border-radius: 6px; margin-left: 10px; transition: all 0.2s; }
        .scan-button:disabled { opacity: 0.6; cursor: not-allowed; }
        #start-button { background-color: var(--accent-green); }
        #stop-button { background-color: var(--accent-red); }

        /* --- Radio Button Flags --- */
        .flags-container { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 15px; }
        .flag-item { display: flex; align-items: center; }
        .flag-item input[type="radio"] { opacity: 0; width: 0; height: 0; }
        .flag-item label { cursor: pointer; position: relative; padding-left: 30px; user-select: none; }
        .flag-item label:before {
            content: ''; position: absolute; left: 0; top: 1px; width: 18px; height: 18px;
            border: 2px solid var(--border-color); background-color: var(--dark-bg-primary); border-radius: 50%;
        }
        .flag-item input[type="radio"]:checked + label:before { border-color: var(--accent-cyan); }
        .flag-item input[type="radio"]:checked + label:after {
            content: ''; position: absolute; left: 5px; top: 6px; width: 10px; height: 10px;
            background-color: var(--accent-cyan); border-radius: 50%;
        }
        
        #console-output { background-color: #010409; padding: 15px; height: 350px; overflow-y: scroll; font-family: 'Fira Code', monospace; font-size: 14px; border-radius: 6px; border: 1px solid var(--border-color); }
        
        /* --- FILE EXPLORER STYLES --- */
        .explorer-container { display: flex; gap: 25px; min-height: 400px; max-height: 60vh; }
        .directory-tree { width: 35%; flex-shrink: 0; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; }
        .file-viewer { width: 65%; display: flex; flex-direction: column; }
        #directory-listing { list-style: none; padding: 0; margin: 0; }
        #directory-listing li { padding: 8px 10px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 10px; user-select: none; word-break: break-all; }
        #directory-listing li:hover { background-color: #222c38; }
        #directory-listing li.active-file { background-color: var(--accent-cyan); color: var(--dark-bg-primary); font-weight: bold; }
        #file-content { background-color: #010409; white-space: pre-wrap; word-wrap: break-word; flex-grow: 1; overflow-y: auto; padding: 15px; border-radius: 6px; border: 1px solid var(--border-color); }
        .icon-folder::before { content: 'üìÅ'; } .icon-file::before { content: 'üìÑ'; }
        #current-path-display, #current-file-display { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);}

        /* --- NEW IMAGE MODAL STYLES --- */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.9); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            margin: auto;
            display: block;
            max-width: 80%;
            max-height: 80%;
            animation-name: zoom;
            animation-duration: 0.4s;
        }
        @keyframes zoom {
            from {transform: scale(0)}
            to {transform: scale(1)}
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .modal-close:hover, .modal-close:focus {
            color: var(--accent-cyan);
            text-decoration: none;
        }
        /* Style for image previews in the file viewer */
        #file-content img {
            max-width: 100%;
            border-radius: 6px;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        #file-content img:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
<div class="container">
    <header><h1>Sleuth Recon Interface</h1></header>

    <div id="scan-controls" class="card">
        <div class="tabs">
            <button class="tab-button active" data-tab="simple">Simple Scan</button>
            <button class="tab-button" data-tab="manual">Manual Command</button>
        </div>
        <div id="simple" class="tab-content active">
            <form id="simple-scan-form">
                <input type="text" id="simple-target" class="input-field" placeholder="e.g., example.com" required>
                <h3>Select Scan Type</h3>
                <div class="flags-container">
                    <div class="flag-item"><input type="radio" name="scan-flag" id="flag-s" value="-s" checked><label for="flag-s">Subdomains</label></div>
                    <div class="flag-item"><input type="radio" name="scan-flag" id="flag-r" value="-r"><label for="flag-r">Full Recon</label></div>
                    <div class="flag-item"><input type="radio" name="scan-flag" id="flag-p" value="-p"><label for="flag-p">Passive</label></div>
                    <div class="flag-item"><input type="radio" name="scan-flag" id="flag-w" value="-w"><label for="flag-w">Web</label></div>
                    <div class="flag-item"><input type="radio" name="scan-flag" id="flag-n" value="-n"><label for="flag-n">OSINT</label></div>
                    <div class="flag-item"><input type="radio" name="scan-flag" id="flag-a" value="-a"><label for="flag-a">All (Attacks)</label></div>
                </div>
            </form>
        </div>
        <div id="manual" class="tab-content">
            <form id="manual-scan-form">
                <input type="text" id="manual-command" class="input-field" style="width: 80%; font-family: 'Fira Code', monospace;" value="./sleuth.sh -d example.com -r">
            </form>
        </div>
        <div style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
             <button type="button" id="start-button" class="scan-button">Start Scan</button>
             <button type="button" id="stop-button" class="scan-button" disabled>Stop Scan</button>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 10px;">Live Console Output</h3>
        <div id="console-output"></div>
    </div>

    <!-- *** NEW FILE EXPLORER IS THE ONLY RESULTS VIEW *** -->
    <div class="card">
        <h3>File Explorer</h3>
        <div class="explorer-container">
            <div class="directory-tree">
                <h4 id="current-path-display">No scan active</h4>
                <ul id="directory-listing"></ul>
            </div>
            <div class="file-viewer">
                <h4 id="current-file-display">Select a file to view</h4>
                <div id="file-content"></div>
            </div>
        </div>
    </div>
</div>

<div id="image-modal" class="modal-overlay">
    <span class="modal-close">√ó</span>
    <img class="modal-content" id="zoomed-image">
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    const startButton = $('#start-button'), stopButton = $('#stop-button'), consoleOutput = $('#console-output');
    let consoleEventSource, notificationEventSource, activeTab = 'simple', currentBasePath = '';

    // --- Tab Switching ---
    $('.tab-button').on('click', function() {
        $('.tab-button').removeClass('active'); $(this).addClass('active');
        activeTab = $(this).data('tab');
        $('.tab-content').removeClass('active'); $('#' + activeTab).addClass('active');
    });

    // --- Unified Start Scan ---
    startButton.on('click', async function() {
        let payload = { scan_type: activeTab };
        if (activeTab === 'simple') {
            payload.target = $('#simple-target').val();
            payload.flag = $('input[name="scan-flag"]:checked').val();
        } else {
            payload.command = $('#manual-command').val();
        }
        resetUI();
        try {
            const response = await fetch('/start-scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || "Unknown error starting scan.");
            
            currentBasePath = result.basePath;
            if (currentBasePath) {
                loadDirectoryTree(currentBasePath);
            }
            connectToStreams();
        } catch (error) {
            consoleOutput.append(`<span style="color:var(--accent-red);"><b>Error:</b> ${error.message}</span><br>`);
            handleScanEnd();
        }
    });

    // --- Stop Scan ---
    stopButton.on('click', async () => {
        consoleOutput.append(`<span style="color:var(--accent-red);"><b>Sending stop signal...</b></span><br>`);
        await fetch('/stop-scan', { method: 'POST' });
    });

    // --- UI & Stream Handling ---
    function resetUI() {
        consoleOutput.html('');
        $('#directory-listing, #file-content').empty();
        $('#current-path-display').text('Scan starting...');
        $('#current-file-display').text('Select a file');
        startButton.prop('disabled', true); stopButton.prop('disabled', false);
        if (consoleEventSource) consoleEventSource.close();
        if (notificationEventSource) notificationEventSource.close();
    }

    function connectToStreams() {
        consoleEventSource = new EventSource('/stream-console');
        consoleEventSource.onmessage = e => {
            if (e.data.includes("--- CONSOLE STREAM FINISHED ---")) handleScanEnd();
            consoleOutput.append(e.data);
            consoleOutput.scrollTop(consoleOutput[0].scrollHeight);
        };
        consoleEventSource.onerror = handleScanEnd;

        notificationEventSource = new EventSource('/stream-file-notifications');
        notificationEventSource.onmessage = e => {
            const update = JSON.parse(e.data);
            if (update.action === 'refresh_tree') {
                const currentVisiblePath = $('#current-path-display').text();
                if (currentVisiblePath && !currentVisiblePath.startsWith('Error:')) {
                    loadDirectoryTree(currentVisiblePath);
                }
            }
        };
    }

    function cleanPath(path) {
    return path.replace(/^\/+|\/+$/g, '')      // remove leading/trailing slashes
               .replace(/^Recon\/?/, '');      // remove leading 'Recon/' if present
    }

    // --- File Explorer Logic ---
    async function loadDirectoryTree(path) {
        try {
            path = cleanPath(path || '');
            const response = await fetch(`/api/list_directory?path=${encodeURIComponent(path)}`);
            if (!response.ok) {
                const err = await response.json().catch(() => ({ error: 'Failed to parse error JSON.' }));
                throw new Error(err.error || `Server responded with ${response.status}`);
            }
            const data = await response.json();
            
            $('#current-path-display').text(data.path);
            const list = $('#directory-listing').empty();
            
            if (data.path && data.path.includes('/')) {
                const parentPath = data.path.substring(0, data.path.lastIndexOf('/'));
                list.append(`<li class="folder-item" data-path="${parentPath}"><span class="icon-folder"></span>.. (Up)</li>`);
            }
            data.folders.forEach(f => list.append(`<li class="folder-item" data-path="${data.path}/${f}"><span class="icon-folder"></span>${f}</li>`));
            data.files.forEach(f => list.append(`<li class="file-item" data-path="${data.path}/${f}"><span class="icon-file"></span>${f}</li>`));
        } catch (error) {
            console.error("Error in loadDirectoryTree:", error);
            $('#current-path-display').html(`<span style="color:var(--accent-red);">${error.message}</span>`);
        }
    }

    async function loadFileContent(path) {
        // Clear previous content
        $('#file-content').empty();
        $('#current-file-display').text(path);
        
        const fileExtension = path.split('.').pop().toLowerCase();
        const imageExtensions = ['png', 'jpg', 'jpeg', 'gif', 'webp'];

        if (imageExtensions.includes(fileExtension)) {
            // --- HANDLE IMAGES ---
            // Create an image tag pointing to our new API endpoint
            const imageUrl = `/api/get_image?path=${encodeURIComponent(path)}`;
            const imageElement = $('<img>').attr('src', imageUrl).attr('alt', path);
            
            // Add click event to the preview to open the zoom modal
            imageElement.on('click', function() {
                $('#zoomed-image').attr('src', $(this).attr('src'));
                $('#image-modal').css('display', 'flex');
            });

            $('#file-content').append(imageElement);

        } else {
            // --- HANDLE TEXT FILES (as before) ---
            try {
                const response = await fetch(`/api/get_file?path=${encodeURIComponent(path)}`);
                if (!response.ok) {
                    const err = await response.json().catch(() => ({ error: 'Failed to parse error JSON.' }));
                    throw new Error(err.error || `Server responded with ${response.status}`);
                }
                const data = await response.json();
                // Use <pre> for better text formatting
                const preElement = $('<pre>').text(data.content || '(Empty File)');
                $('#file-content').append(preElement);

            } catch (error) {
                console.error("Error in loadFileContent:", error);
                $('#file-content').text(`Error loading file: ${error.message}`);
            }
        }
    }

    // Event delegation for dynamically created list items
    $('#directory-listing').on('click', 'li.folder-item', function() { loadDirectoryTree($(this).data('path')); });
    $('#directory-listing').on('click', 'li.file-item', function() {
        const path = $(this).data('path');
        loadFileContent(path);
        $('#directory-listing li').removeClass('active-file');
        $(this).addClass('active-file');
    });

    // --- NEW: Event listener for closing the modal ---
    $('#image-modal .modal-close').on('click', function() {
        $('#image-modal').hide();
    });
    // Also close modal by clicking the background
    $('#image-modal').on('click', function(e) {
        if (e.target.id === 'image-modal') {
            $(this).hide();
        }
    });
    
    function handleScanEnd() {
        if (consoleEventSource) consoleEventSource.close();
        if (notificationEventSource) notificationEventSource.close();
        startButton.prop('disabled', false);
        stopButton.prop('disabled', true);
    }
});
</script>
</body>
</html>